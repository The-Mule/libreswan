/testing/guestbin/netbsd-prep.sh
ipsec.conf -> PATH/etc/ipsec.conf
ipsec.secrets -> PATH/etc/ipsec.secrets
west #
 ipsec start
Redirecting to: [initsystem]
pluto(ok)
west #
 ../../guestbin/wait-until-pluto-started
west #
 echo "initdone"
initdone
west #
 ifconfig sec1 create
west #
 ifconfig sec1 inet 192.0.1.251/24 192.0.1.251
west #
 ifconfig sec1 up
west #
 ifconfig sec1
sec1: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 1280
	index 7 priority 0 llprio 3
	groups: sec
	inet 192.0.1.251 --> 192.0.1.251 netmask 0xffffff00
west #
 ../../guestbin/ipsec-kernel-state.sh
west #
 ../../guestbin/ipsec-kernel-policy.sh
west #
 ifconfig sec1 destroy
west #
 ipsec add west
"west": command: 'ifconfig' 'sec1' 'create'
"west": eof: 0; exited yes(0); signaled: no(0); stopped: no(0); core: no
"west": added IKEv2 connection
west #
 ifconfig sec1
sec1: flags=8010<POINTOPOINT,MULTICAST> mtu 1280
	index 8 priority 0 llprio 3
	groups: sec
west #
 ../../guestbin/ipsec-kernel-state.sh
west #
 ../../guestbin/ipsec-kernel-policy.sh
west #
 ipsec up west
"west" #1: initiating IKEv2 connection to 192.1.2.23 using UDP
"west" #1: sent IKE_SA_INIT request to 192.1.2.23:UDP/500
"west" #1: processed IKE_SA_INIT response from 192.1.2.23:UDP/500 {cipher=AES_GCM_16_256 integ=n/a prf=HMAC_SHA2_512 group=DH19}, initiating IKE_AUTH
"west" #1: sent IKE_AUTH request to 192.1.2.23:UDP/500
"west" #1: initiator established IKE SA; authenticated peer using authby=secret and ID_FQDN '@east'
"west" #2: command: 'ifconfig' 'sec1' 'inet' '192.0.1.251/24' '192.0.1.251'
"west" #2: eof: 0; exited yes(0); signaled: no(0); stopped: no(0); core: no
"west" #2: command: 'ifconfig' 'sec1' 'up'
"west" #2: eof: 0; exited yes(0); signaled: no(0); stopped: no(0); core: no
"west" #2: initiator established Child SA using #1; IPsec tunnel [192.0.1.0/24===192.0.2.0/24] {ESP/ESN=>0xESPESP <0xESPESP xfrm=AES_CBC_128-HMAC_SHA1_96 DPD=passive}
west #
 ifconfig sec1
sec1: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 1280
	index 8 priority 0 llprio 3
	groups: sec
	inet 192.0.1.251 --> 192.0.1.251 netmask 0xffffff00
west #
 ../../guestbin/ipsec-kernel-state.sh
@0 esp tunnel from 192.1.2.23 to 192.1.2.45 spi 0xSPISPI auth hmac-sha1 enc aes \
	authkey 0xHASHKEY \
	enckey 0xENCKEY
	sa: spi 0xSPISPI auth hmac-sha1 enc aes
		state mature replay 16 flags 0x404<tunnel,esn>
	lifetime_cur: alloc 0 bytes 0 add N first 0
	lifetime_hard: alloc 0 bytes 0 add N first 0
	lifetime_soft: alloc 0 bytes 0 add N first 0
	address_src: 192.1.2.23
	address_dst: 192.1.2.45
	key_auth: bits 160: HASHKEY
	key_encrypt: bits 128: ENCKEY
	counter:
		0 input packets
		0 output packets
		0 input bytes
		0 output bytes
		0 input bytes, decompressed
		0 output bytes, uncompressed
		0 packets dropped on input
		0 packets dropped on output
	replay: rpl 1
@0 esp tunnel from 192.1.2.45 to 192.1.2.23 spi 0xSPISPI auth hmac-sha1 enc aes \
	authkey 0xHASHKEY \
	enckey 0xENCKEY
	sa: spi 0xSPISPI auth hmac-sha1 enc aes
		state mature replay 16 flags 0x404<tunnel,esn>
	lifetime_cur: alloc 0 bytes 0 add N first 0
	lifetime_hard: alloc 0 bytes 0 add N first 0
	lifetime_soft: alloc 0 bytes 0 add N first 0
	address_src: 192.1.2.45
	address_dst: 192.1.2.23
	key_auth: bits 160: HASHKEY
	key_encrypt: bits 128: ENCKEY
	counter:
		0 input packets
		0 output packets
		0 input bytes
		0 output bytes
		0 input bytes, decompressed
		0 output bytes, uncompressed
		0 packets dropped on input
		0 packets dropped on output
	replay: rpl 1
west #
 ../../guestbin/ipsec-kernel-policy.sh
@0 flow esp in from 192.0.2.0/24 to 192.0.1.0/24 local 192.1.2.45 peer 192.1.2.23 type require
@1 flow esp out from 192.0.1.0/24 to 192.0.2.0/24 local 192.1.2.45 peer 192.1.2.23 type require
west #
 ../../guestbin/tcpdump.sh --start -i sec1
tcpdump started
west #
 ../../guestbin/ping-once.sh --up -I 192.0.1.251 192.0.2.254
up
west #
 ../../guestbin/ping-once.sh --up -I sec1 192.0.2.254
down UNEXPECTED
# fping  -c 1  --timeout 5s   --src sec1 192.0.2.254
fping: can't parse source address: sec1
west #
 ../../guestbin/ipsec-kernel-state.sh
@0 esp tunnel from 192.1.2.23 to 192.1.2.45 spi 0xSPISPI auth hmac-sha1 enc aes \
	authkey 0xHASHKEY \
	enckey 0xENCKEY
	sa: spi 0xSPISPI auth hmac-sha1 enc aes
		state mature replay 16 flags 0x404<tunnel,esn>
	lifetime_cur: alloc 0 bytes 96 add N first N
	lifetime_hard: alloc 0 bytes 0 add N first 0
	lifetime_soft: alloc 0 bytes 0 add N first 0
	address_src: 192.1.2.23
	address_dst: 192.1.2.45
	key_auth: bits 160: HASHKEY
	key_encrypt: bits 128: ENCKEY
	lifetime_lastuse: alloc 0 bytes 0 add 0 first N
	counter:
		1 input packet
		0 output packets
		248 input bytes
		0 output bytes
		104 input bytes, decompressed
		0 output bytes, uncompressed
		0 packets dropped on input
		0 packets dropped on output
	replay: rpl 1
@0 esp tunnel from 192.1.2.45 to 192.1.2.23 spi 0xSPISPI auth hmac-sha1 enc aes \
	authkey 0xHASHKEY \
	enckey 0xENCKEY
	sa: spi 0xSPISPI auth hmac-sha1 enc aes
		state mature replay 16 flags 0x404<tunnel,esn>
	lifetime_cur: alloc 0 bytes 84 add N first N
	lifetime_hard: alloc 0 bytes 0 add N first 0
	lifetime_soft: alloc 0 bytes 0 add N first 0
	address_src: 192.1.2.45
	address_dst: 192.1.2.23
	key_auth: bits 160: HASHKEY
	key_encrypt: bits 128: ENCKEY
	lifetime_lastuse: alloc 0 bytes 0 add 0 first N
	counter:
		0 input packets
		1 output packet
		0 input bytes
		152 output bytes
		0 input bytes, decompressed
		104 output bytes, uncompressed
		0 packets dropped on input
		0 packets dropped on output
	replay: rpl 2
west #
 ../../guestbin/ipsec-kernel-policy.sh
@0 flow esp in from 192.0.2.0/24 to 192.0.1.0/24 local 192.1.2.45 peer 192.1.2.23 type require
@1 flow esp out from 192.0.1.0/24 to 192.0.2.0/24 local 192.1.2.45 peer 192.1.2.23 type require
west #
 ../../guestbin/tcpdump.sh --stop -i sec1
west #
 ipsec down west
"west": terminating SAs using this connection
"west" #1: sent INFORMATIONAL request to delete IKE SA
"west" #2: command: 'ifconfig' 'sec1' 'delete' 'inet' '192.0.1.251/24' '192.0.1.251'
"west" #2: eof: 256; exited yes(1); signaled: no(0); stopped: no(1); core: no
"west" #2: delete ipsec-interface sec1@vio1 IP [192.0.1.251/24] added by pluto
"west" #2: failed to pull traffic counters from outbound IPsec SA
"west" #2: failed to pull traffic counters from inbound IPsec SA
"west" #2: ESP traffic information: in=0B out=0B
"west" #1: deleting IKE SA (established IKE SA)
west #
 ipsec delete west
"west": command: 'ifconfig' 'sec1' 'destroy'
"west": eof: 0; exited yes(0); signaled: no(0); stopped: no(0); core: no
"west": delete ipsec-interface sec1@vio1 added by pluto
west #
 
